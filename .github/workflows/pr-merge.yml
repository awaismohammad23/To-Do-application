name: PR Merge Pipeline

on:
  pull_request:
    types:
      - closed

jobs:
  on-merge:
    name: Run on PR Merge
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run database migrations
        run: |
          python manage.py makemigrations --check
          python manage.py migrate --check
        env:
          DJANGO_SETTINGS_MODULE: todo_project.settings
          SECRET_KEY: test-secret-key-for-ci

      - name: Run full test suite
        run: |
          python manage.py test tasks --verbosity=2
        env:
          DJANGO_SETTINGS_MODULE: todo_project.settings
          SECRET_KEY: test-secret-key-for-ci

      - name: Check for migration conflicts
        run: |
          python manage.py makemigrations --dry-run --check
        env:
          DJANGO_SETTINGS_MODULE: todo_project.settings
          SECRET_KEY: test-secret-key-for-ci

      - name: Validate Django settings
        run: |
          python manage.py check
        env:
          DJANGO_SETTINGS_MODULE: todo_project.settings
          SECRET_KEY: test-secret-key-for-ci

      - name: Success notification
        if: success()
        run: |
          echo "✅ PR merged successfully! All checks passed."

      - name: Failure notification
        if: failure()
        run: |
          echo "❌ PR merge checks failed. Please review the errors above."

